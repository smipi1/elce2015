
Unroll crc32 calculation on small systems


 init/Kconfig    |   14 	14 +	0 -	0 !
 lib/Makefile    |    2 	2 +	0 -	0 !
 lib/crc32.c     |    2 	2 +	0 -	0 !
 lib/crc32defs.h |    9 	8 +	1 -	0 !
 4 files changed, 26 insertions(+), 1 deletion(-)

Index: linux-2.6.23-rc9/init/Kconfig
===================================================================
--- linux-2.6.23-rc9.orig/init/Kconfig	2007-10-08 23:52:27.000000000 +0200
+++ linux-2.6.23-rc9/init/Kconfig	2007-10-09 00:30:18.000000000 +0200
@@ -557,6 +557,16 @@
 	  option replaces shmem and tmpfs with the much simpler ramfs code,
 	  which may be appropriate on small systems without swap.
 
+config CRC32_TABLES
+	depends CRC32
+	default y
+	bool "Calculate CRC32 with tables" if EMBEDDED
+	help
+	  This option enables use of tables for CRC calculation. Disabling
+          reduces kernel size by about 2K. This may actually result in
+          faster code on machines with limited memory bandwidth.
+
+
 config VM_EVENT_COUNTERS
 	default y
 	bool "Enable VM event counters for /proc/vmstat" if EMBEDDED
@@ -635,6 +645,10 @@
 	boolean
 	select PLIST
 
+config CRC32_CALC
+	default !CRC32_TABLES
+	bool
+
 config TINY_SHMEM
 	default !SHMEM
 	bool
Index: linux-2.6.23-rc9/lib/Makefile
===================================================================
--- linux-2.6.23-rc9.orig/lib/Makefile	2007-10-08 23:51:25.000000000 +0200
+++ linux-2.6.23-rc9/lib/Makefile	2007-10-08 23:52:27.000000000 +0200
@@ -69,7 +69,9 @@
 hostprogs-y	:= gen_crc32table
 clean-files	:= crc32table.h
 
+ifeq ($(CONFIG_CRC32_TABLES),y)
 $(obj)/crc32.o: $(obj)/crc32table.h
+endif
 
 quiet_cmd_crc32 = GEN     $@
       cmd_crc32 = $< > $@
Index: linux-2.6.23-rc9/lib/crc32.c
===================================================================
--- linux-2.6.23-rc9.orig/lib/crc32.c	2007-07-09 01:32:17.000000000 +0200
+++ linux-2.6.23-rc9/lib/crc32.c	2007-10-08 23:52:27.000000000 +0200
@@ -36,7 +36,9 @@
 #define tole(x) (x)
 #define tobe(x) (x)
 #endif
+#ifdef CONFIG_CRC32_TABLES
 #include "crc32table.h"
+#endif
 
 MODULE_AUTHOR("Matt Domsch <Matt_Domsch@dell.com>");
 MODULE_DESCRIPTION("Ethernet CRC32 calculations");
Index: linux-2.6.23-rc9/lib/crc32defs.h
===================================================================
--- linux-2.6.23-rc9.orig/lib/crc32defs.h	2007-07-09 01:32:17.000000000 +0200
+++ linux-2.6.23-rc9/lib/crc32defs.h	2007-10-08 23:52:27.000000000 +0200
@@ -7,8 +7,15 @@
 #define CRCPOLY_BE 0x04c11db7
 
 /* How many bits at a time to use.  Requires a table of 4<<CRC_xx_BITS bytes. */
+
+#ifdef CONFIG_CRC32_CALC /* config symbols not visible to gen_crc32table */
+#define CRC_LE_BITS 1
+#define CRC_BE_BITS 1
+#endif
+
 /* For less performance-sensitive, use 4 */
-#ifndef CRC_LE_BITS 
+
+#ifndef CRC_LE_BITS
 # define CRC_LE_BITS 8
 #endif
 #ifndef CRC_BE_BITS
