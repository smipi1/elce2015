
configurable support for PCI quirks

From: Zwane Mwaikambo <zwane@arm.linux.org.uk>
Subject: [PATCH][2.6-tiny] remove PCI quirks

---
 drivers/pci/quirks.c |   13 	11 +	2 -	0 !
 init/Kconfig         |    8 	8 +	0 -	0 !
 2 files changed, 19 insertions(+), 2 deletions(-)

Index: linux-2.6.23-rc9/drivers/pci/quirks.c
===================================================================
--- linux-2.6.23-rc9.orig/drivers/pci/quirks.c	2007-10-08 23:51:14.000000000 +0200
+++ linux-2.6.23-rc9/drivers/pci/quirks.c	2007-10-09 00:29:05.000000000 +0200
@@ -34,6 +34,11 @@
 DECLARE_PCI_FIXUP_FINAL(PCI_VENDOR_ID_MELLANOX,PCI_DEVICE_ID_MELLANOX_TAVOR,quirk_mellanox_tavor);
 DECLARE_PCI_FIXUP_FINAL(PCI_VENDOR_ID_MELLANOX,PCI_DEVICE_ID_MELLANOX_TAVOR_BRIDGE,quirk_mellanox_tavor);
 
+int isa_dma_bridge_buggy;		/* Exported */
+int pci_pci_problems;
+EXPORT_SYMBOL(pci_pci_problems);
+
+#ifdef CONFIG_PCI_QUIRKS
 /* Deal with broken BIOS'es that neglect to enable passive release,
    which can cause problems in combination with the 82441FX/PPro MTRRs */
 static void quirk_passive_release(struct pci_dev *dev)
@@ -83,8 +88,6 @@
 DECLARE_PCI_FIXUP_FINAL(PCI_VENDOR_ID_NEC,	PCI_DEVICE_ID_NEC_CBUS_2,	quirk_isa_dma_hangs );
 DECLARE_PCI_FIXUP_FINAL(PCI_VENDOR_ID_NEC,	PCI_DEVICE_ID_NEC_CBUS_3,	quirk_isa_dma_hangs );
 
-int pci_pci_problems;
-EXPORT_SYMBOL(pci_pci_problems);
 
 /*
  *	Chipsets where PCI->PCI transfers vanish or hang
@@ -1573,6 +1576,12 @@
 }
 EXPORT_SYMBOL(pci_fixup_device);
 
+#else
+void pci_fixup_device(enum pci_fixup_pass pass, struct pci_dev *dev)
+{
+}
+#endif /* CONFIG_PCI_QUIRKS */
+
 /* Enable 1k I/O space granularity on the Intel P64H2 */
 static void __devinit quirk_p64h2_1k_io(struct pci_dev *dev)
 {
Index: linux-2.6.23-rc9/init/Kconfig
===================================================================
--- linux-2.6.23-rc9.orig/init/Kconfig	2007-10-09 00:29:04.000000000 +0200
+++ linux-2.6.23-rc9/init/Kconfig	2007-10-09 00:29:26.000000000 +0200
@@ -777,6 +777,14 @@
           this feature if you are only need legacy serial support.
 	  Saves about 9K.
 
+config PCI_QUIRKS
+	default y
+	bool "Enable PCI quirk workarounds" if EMBEDDED
+	help
+	  This enables workarounds for various PCI chipset bugs/quirks.
+	  Disable this only if you know your target machine is unaffected
+	  by PCI quirks.
+
 endmenu		# General setup
 
 config RT_MUTEXES
